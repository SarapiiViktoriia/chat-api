<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../assets/css/output.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="../assets/js/jquery.cookie.js"></script>
</head>
<body>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font: 13px Helvetica, Arial;
        }
        form {
            background: #000;
            padding: 3px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        form input {
            border: 0;
            padding: 10px;
            width: 90%;
            margin-right: .5%;
        }
        form button {
            width: 9%;
            background: rgb(130, 224, 255);
            border: none;
            padding: 10px;
        }
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        #messages li {
            padding: 5px 10px;
        }
        #messages li:nth-child(odd) {
            background: #eee;
        }
        .tagName {
            background: #000;
            padding: 10px;
            width: 100%;
        }
        /* 
        .listMsg {
            margin-top: 20%;
        } */
    </style>
    </head>
    <body>
        <div class="tagName">
            <h1 class="text-white uppercase font-extrabold" id="username"></h1>
        </div>
        <div class="listMsg">
            <ul id="messages"></ul>
        </div>
        <form action="">
            <input id="m" autocomplete="off" /><button>Send</button>
        </form>
    </body>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    $(document).ready(() => {
        var urlData = window.location.host.toString()
        var getUrl = urlData.substring(0, 10)
        var url = `http://${getUrl}`
        var port = "6969"
        var prefix = "/api"
        $.ajaxSetup({
            headers: { 'Authorization': $.cookie('token') }
        });
        $.ajax({
            type: 'GET',
            url: `${url}${port}${prefix}/users/me`,
            headers: { 'Authorization': $.cookie('token') },
            success: (data) => {
                let username = data.user.username
                let x = window.location.href
                let getId = x.substring(x.lastIndexOf('/') + 1)
                $.get(`${url}${port}${prefix}/conversations/${getId}`).done((value) => {
                    let participants = value.conversation.participants
                    let conversationId = value.conversation._id
                    $.each(participants, (key, value) => {
                        if (username != value.username) {
                            $('#username').append('@' + value.username)
                        }
                    })
                    $(() => {
                        socket.emit('userJoined', username)
                        socket.on('userJoined', (username) => {
                            // $('#messages').append($('<li>').text(username + " Joined"));
                            console.log(username + " Joined");
                        })
                    })
                    $(() => {
                        $.get(`${url}3001${prefix}/messages`, (data) => {
                            console.log(data);
                            $.each(data, (key, value) => {
                                console.log(value);
                                $('#messages').append($('<li>').text(value.sender + ": " + value.content));
                            })
                        })
                        $('form').submit(function (e) {
                            e.preventDefault();
                            let content = $('#m').val()
                            socket.emit('newMessage',
                                username, content, conversationId
                            );
                            $.post(`${url}3001${prefix}/messages`, {
                                sender: username,
                                content: content,
                                conversationId: conversationId
                            })
                            $('#m').val('');
                            return false;
                        });
                        socket.on('newMessage', function (data) {
                            console.log(data);
                            $('#messages').append($('<li>').text(data.sender + ": " + data.content));
                            window.scrollTo(0, document.body.scrollHeight);
                        });
                    });
                })
            }
        })
    })
</script>
</html>
