<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../assets/css/output.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="../assets/js/jquery.cookie.js"></script>
</head>
<style>
    table,
    th,
    td {
        border: 1px solid black;
    }
</style>
<body>
    <div id="tabs">
        <ul class="flex border-b">
            <li class="mr-1">
                <a class="bg-white inline-block rounded-t py-2 px-4 text-blue-700 font-semibold"
                    href="#profile">Profile</a>
            </li>
            <li class="mr-1">
                <a class="bg-white inline-block rounded-t py-2 px-4 text-blue-700 font-semibold"
                    href="#contact">Contact</a>
            </li>
            <li class="mr-1">
                <a class="bg-white inline-block rounded-t py-2 px-4 text-blue-700 font-semibold" href="#chat">
                    Obrolan</a>
            </li>
            <li class="mr-1">
                <a class="bg-white inline-block rounded-t py-2 px-4 text-blue-700 font-semibold"
                    href="#setting">Setting</a>
            </li>
        </ul>
        <div id="profile">
            <div class="md:flex bg-white rounded-lg p-6">
                <div id="avatar"></div>
                <div class="text-center md:text-left">
                    <h2 class="text-lg" id="username"></h2>
                    <div class="text-purple-500" id="bio"></div>
                    <div class="text-gray-600" id="email"></div>
                </div>
            </div>
        </div>
        <div id="contact">
            <div class="md:flex bg-white rounded-lg p-6">
                <table id="listContact">
                    <tr>
                        <td>Username</td>
                        <td>Action</td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="chat">
            <div class="md:flex bg-white rounded-lg p-6">
                <table id="listObrolan">
                    <tr>
                        <td>Username</td>
                        <td>Action</td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="setting">
            <form id="logout">
                <button type="submit"
                    class="bg-white hover:bg-red-400 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow">
                    Log Out
                </button>
            </form>
        </div>
    </div>
</body>
<script>
    $(document).ready(() => {
        var url = "http://128.199.160.243:"
        var port = "6969"
        var prefix = "/api"
        $.ajaxSetup({
            headers: { 'Authorization': $.cookie('token') }
        });
        $.ajax({
            type: 'GET',
            url: `${url}${port}${prefix}/users/me`,
            headers: { 'Authorization': $.cookie('token') },
            success: (data) => {
                $('#username').append(data.user.username)
                $('#bio').append(data.user.bio)
                $('#email').append(data.user.email)
                $('#avatar').append('<img class="h-16 w-16 md:h-24 md:w-24 rounded-full mx-auto md:mx-0 md:mr-6" src="' + data.user.avatar + '">')
            }
        })
        $.ajax({
            type: 'GET',
            url: `${url}${port}${prefix}/users/me/contact`,
            headers: { 'Authorization': $.cookie('token') },
            success: (data) => {
                for (let i = 0; i < data.contacts.length; i++) {
                    const value = data.contacts[i].username
                    const index = data.contacts[i]._id
                    $("#listContact tbody").append('<tr><td>' + value
                        + '</td><td><button class="btnChat" data-id="' + index + '" data-name="' + value + '">chat</button></td>"'
                        + '</tr>')
                    $('.btnChat').each(function () {
                        var $this = $(this);
                        $this.on("click", function () {
                            let dataId = $(this).data('id')
                            let dataUsername = $(this).data('name')
                            $.post(`${url}${port}${prefix}/conversations/store`, { _id: dataId, username: dataUsername }).done((data) => {
                                // $(location).attr('href', "/chat");
                                alert("succes!")
                            })
                        });
                    });
                }
            }
        })
        $.ajax({
            type: 'GET',
            url: `${url}${port}${prefix}/conversations`,
            headers: { 'Authorization': $.cookie('token') },
            success: (data) => {
                $.get(`${url}${port}${prefix}/users/me`).done((value) => {
                    let user = value.user.username;
                    for (let i = 0; i < data.conversations.length; i++) {
                        const value = data.conversations[i];
                        for (let x = 0; x < data.conversations[i].participants.length; x++) {
                            const element = data.conversations[i].participants[x].username;
                            const id = data.conversations[i].participants[x]._id;
                            if (user != element) {
                                $("#listObrolan tbody").append('<tr><td>' + element
                                    + '</td><td><button class="btnKlik" data-name="' + element + '"> klik!</button></td>"'
                                    + '</tr>')
                                $('.btnKlik').click((event) => {
                                    window.open(`/chat/${value._id}`, '_blank')
                                })
                            }
                        }
                    }
                })
            }
        })
        $(() => {
            $("#tabs").tabs();
        });
        $('#logout').submit((event) => {
            $.removeCookie("token")
            $(location).attr('href', "/");
            event.preventDefault()
        })
    })
</script>
</html>
